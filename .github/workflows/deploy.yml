name: Deploy to GitHub Pages

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          cd docs
          npm init -y
          npm install --save-dev html-minifier clean-css-cli uglify-js

      - name: Build and optimize
        run: |
          cd docs
          # Minify CSS
          npx clean-css-cli -o style.min.css style.css

          # Minify JavaScript
          npx uglifyjs script.js -o script.min.js -c -m

          # Minify HTML (optional)
          npx html-minifier --collapse-whitespace --remove-comments --minify-css --minify-js index.html -o index.min.html

          # Use minified files in production
          sed -i 's/style\.css/style.min.css/g' index.html
          sed -i 's/script\.js/script.min.js/g' index.html

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test installer script
        run: |
          # Basic syntax check
          bash -n installer.sh

          # Check if script has proper permissions
          chmod +x installer.sh

          # Test help functionality (dry run)
          echo "Testing installer help..."
          bash installer.sh --help || echo "Help test completed"

      - name: Validate HTML
        run: |
          # Install html5validator
          pip install html5validator

          # Validate HTML files
          html5validator --root docs/ --ignore-re 'Attribute ".*" not allowed on element ".*" at this point.'

      - name: Check links
        run: |
          # Install link checker
          npm install -g markdown-link-check

          # Check README links
          markdown-link-check README.md --config .github/workflows/link-check-config.json || true

  security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run security scan on installer script
        run: |
          # Check for common security issues in shell scripts
          if command -v shellcheck &> /dev/null; then
            shellcheck installer.sh || echo "Shellcheck warnings found"
          else
            echo "Shellcheck not available, skipping security scan"
          fi

      - name: Check for secrets in code
        run: |
          # Basic check for potential secrets
          if grep -r "password\|secret\|key\|token" docs/ --exclude-dir=.git; then
            echo "Warning: Potential secrets found in docs"
            exit 1
          fi
